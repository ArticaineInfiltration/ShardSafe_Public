{% extends 'login/login.html' %}

{% block content %}
<div class="container mt-5" style="max-width: 500px;">
  <h2 class="mb-4">Reset Password</h2>

  <form id="resetForm" onsubmit="return false;">
    <div class="mb-3">
      <label for="username" class="form-label">Username</label>
      <input type="text" id="username" class="form-control" required>
    </div>

    <div class="mb-3">
      <label for="resetKey" class="form-label">Reset Key</label>
      <input type="password" id="resetKey" class="form-control" required>
    </div>

    <div class="mb-3">
      <label for="newPassword" class="form-label">New Password</label>
      <input type="password" id="newPassword" class="form-control" required
        pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}"
        title="Must contain at least one number, one uppercase, one lowercase letter, and at least 8 characters">
    </div>

    <button type="submit" class="btn btn-dark w-100" onclick="handleResetSubmit()">Reset Password</button>
  </form>
</div>

<script src="{{ url_for('static', filename='js/crypto.js') }}"></script>
<script>

const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

async function handleResetSubmit() {
  const username = document.getElementById("username").value.trim();
  const resetKey = document.getElementById("resetKey").value.trim();
  const newPassword = document.getElementById("newPassword").value.trim();

  if (!username || !resetKey || !newPassword) {
    alert("All fields are required.");
    return;
  }

  // 1. Get reset metadata
  const metadataRes = await fetch("{{url_for('auth.forgotPasswordFetchController')}}", {
    method: "POST",
     headers: {
    "Content-Type": "application/json",
     "X-CSRFToken": csrfToken

      },
    body: JSON.stringify({ username })
  });
  const metadata = await metadataRes.json();
  if (!metadata.success) {
    alert(metadata.message);
    return;
  }

  const { resetPrivateKey, resetIV,resetEncPrivateKey, resetEncIV } = metadata;
  console.log(resetPrivateKey);
  console.log(resetIV);

  // 2. Derive key from reset key
  const derivedResetKey = await importAESKeyFromHex(resetKey);
  console.log(derivedResetKey);
  
  // 3. Decrypt private key
  const decryptedKey = await decryptEncPrivateKey(resetPrivateKey, derivedResetKey, resetIV);
  const decryptedEncKey = await decryptEncPrivateKey(resetEncPrivateKey, derivedResetKey, resetEncIV);
  if (!decryptedKey || !decryptedEncKey) {
    alert("Reset key incorrect or decryption failed.");
    return;
  }

  // 4. Generate new salt and derive new key from new password
  const loginSalt = generateSalt();
  const newLoginKey = await deriveKeyFromPassword(newPassword, loginSalt);
  const encSalt = generateSalt();
  const newEncKey = await deriveKeyFromPassword(newPassword, encSalt);


  // 5. Encrypt the private key with new password key
  const loginPKIV = await encryptPrivateKey(decryptedKey, newLoginKey);
  const encPKIV = await encryptPrivateKey(decryptedEncKey, newEncKey);
  
  const encryptedPrivateKey = loginPKIV.encryptedPrivateKey;
  const loginIV = loginPKIV.iv;

  const encryptedEncPrivateKey = encPKIV.encryptedPrivateKey;
  const encIV = encPKIV.iv;
  

  // 6. Convert outputs to base64
  const loginKeyB64 = arrayBufferToBase64(encryptedPrivateKey);
  console.log("loginKeyB64 (Encrypted Login Private Key):", loginKeyB64);

  const loginIVB64 = bufferToBase64(loginIV);
  console.log("loginIVB64 (Login IV):", loginIVB64);

  const encKeyB64 = arrayBufferToBase64(encryptedEncPrivateKey);
  console.log("encKeyB64 (Encrypted Encryption Private Key):", encKeyB64);

  const encIVB64 = bufferToBase64(encIV);
  console.log("encIVB64 (Encryption IV):", encIVB64);


  const passwordHash = await hashPassword(newPassword);

  // 7. Send final update
  const updateRes = await fetch("{{url_for('auth.resetPasswordController')}}", {
    method: "POST",
    headers: { 
       "X-CSRFToken": csrfToken,
      "Content-Type": "application/json" },
    body: JSON.stringify({
      username,
      newPrivateKey: loginKeyB64,
      newLoginIV: loginIVB64,
      loginSalt: loginSalt,

      newEncPrivateKey: encKeyB64,
      newEncIV: encIVB64,
      encSalt: encSalt,

      
      newPasswordHash: passwordHash
    })
  });

  const updateJson = await updateRes.json();
  alert(updateJson.message);
  if (updateJson.success) {
    window.location.href = "/login"; // redirect to login
  }
}
</script>
{% endblock %}
