{% macro newgroup_modal(form) %}

<div class="modal fade" id="newGroupModal" tabindex="-1" aria-labelledby="newGroupModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">

      <form method="POST" id="createGroupForm" action="{{ url_for('group.createGroupController') }}">
       <input type="hidden" id="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-header">
          <h5 class="modal-title" id="createGroupModalLabel">Create Group</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label for="groupName">Group Name</label><br>
           <input type="text" class="form-control" name="groupName" id="groupName">
          </div>
          <div class="mb-3">
           <label for="description">Description (20 chars max) </label><br>
            <input type="text" id="description" name="description" class="form-control">
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success ">Create Group!</button>
        </div>
      </form>

    </div>
  </div>
</div>
<script src="{{ url_for('static', filename='js/crypto.js') }}"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('createGroupForm');
        const csrfToken = document.getElementById('csrf_token').value;
        const modalElement = document.getElementById('newGroupModal');
        const modal = new bootstrap.Modal(modalElement);

       

        form.addEventListener('submit',  async function (e) {
        e.preventDefault();
            // check if group can be made first:
            const formData = new FormData(form);
            formData.append('step',1); 
            console.log(csrfToken);
            const response1 = await fetch('/creategroup', {
                method: 'POST', 
                credentials: 'same-origin',
                headers: {  
                            'X-CSRFToken': csrfToken,
                            },
                body: formData,
                
                });
            const jsonRes1 = await response1.json();
            console.log(jsonRes1);
            if (!jsonRes1.success){
                
                const cancelButton = document.querySelector('#newGroupModal .btn-secondary[data-bs-dismiss="modal"]');
                form.reset();
                if (cancelButton) {
                cancelButton.click(); 
                }
                showFlashMessage('danger',jsonRes1.message);             
               return null;
            }
        // gen group key: 
            const newSGK = await generateSGK();
            const rawSGK = await crypto.subtle.exportKey('raw', newSGK);
        
        // get owner pub key 
            const encPubKeyB64 = getCookie('encPublicKey');
            
            // import key to cryptokey: 
            const encPublicKey = await importBase64PublicKey(encPubKeyB64);

        // enc sgk with owner pub key 
            const encryptedSGKBuffer = await crypto.subtle.encrypt(
            { name: 'RSA-OAEP' },
            encPublicKey,
            rawSGK
            );

        // Convert encrypted SGK buffer to base64
        const encryptedSGKB64 = bufferToBase64(encryptedSGKBuffer);
        // send to server, creating membership 
            
            const fd = new FormData()
            fd.append('step',2);
            fd.append('encryptedSGKB64',encryptedSGKB64);
            fd.append('group_id',jsonRes1.group_id);
            fd.append('nonceHex',jsonRes1.nonceHex);

            const res2 = await fetch('/creategroup', {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                            'X-CSRFToken': csrfToken,
                            },
                body: fd,
                
                });
            const jsonRes2 = await res2.json();
            if (!jsonRes2.success){
                const cancelButton = document.querySelector('#newGroupModal .btn-secondary[data-bs-dismiss="modal"]');
                form.reset();
                if (cancelButton) {
                cancelButton.click(); 
                }
                showFlashMessage('danger',jsonRes2.message);             
               return null;
            }else{
                const cancelButton = document.querySelector('#newGroupModal .btn-secondary[data-bs-dismiss="modal"]');
                form.reset();
                if (cancelButton) {
                cancelButton.click(); 
                }
                location.reload();
                           
               return null;
            }      

        });
    });

</script>
{% endmacro %}