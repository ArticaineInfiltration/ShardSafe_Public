{% extends 'external/externalbase.html' %}

{% block content %}
<!-- 
d046320ff45de9745ed6e2df53d7b3b7b034d96a5b7e6aa5bb7ae2aed2f563fe -->
<div class="container d-flex justify-content-center align-items-center" style="min-height: 80vh;">
  <div class="d-flex p-4 shadow rounded-4" style="background-color: white; max-width: 1500px; width: 100%;">
    
    <!-- Registration Form -->
    <div class="pe-4" style="flex: 1;">
      <h4 class="mb-4 fw-bolder fs-2">Register for ShardSafe</h4>
      <form id ="registerForm" method="POST" action="{{ url_for('registerUser.registerUserController') }}">

        
        {{ form.hidden_tag() }}
        {{ form.username.label }} {{ form.username(class='form-control') }}<br>
        {{ form.email.label }} {{ form.email(class='form-control') }}<br>
       <label for="password">Password</label>
      <div class="input-group mt-1">
        <input type="password" class=" form-control" id="password">
        <button class="btn btn-outline-secondary" type="button" id="togglePassword" title="Show/Hide Password">
          <i class="bi bi-eye-slash" id="toggleIcon"></i>
        </button>
      </div>
      <div class="mt-3"></div>
      <label for="password2">Confirm Password</label>
      <div class="input-group ">
        <input type="password" class=" form-control" id="password2">
        <button class="btn btn-outline-secondary" type="button" id="togglePassword2" title="Show/Hide Password">
          <i class="bi bi-eye-slash" id="toggleIcon2"></i>
        </button>
      </div>
        <!-- {{form.encPublicKey()}}
        {{form.encPrivateKey()}}
        {{form.encIV()}}
        {{form.encSalt()}}

        {{form.loginPublicKey()}}
        {{form.loginPrivateKey()}}
        {{form.loginIV()}}
        {{form.loginSalt()}} -->
        <div id="keyBoxDiv" style="display: none;">
           <div class="warning">Important: Save your secret key below. It will not be shown again!</div>
           <div class="keyBox" id="keyBox">Generating key...</div>
        </div>
        <div class="d-flex justify-content-center mt-3">
          {{ form.register(class='custom-grey-btn px-5') }}
        </div>
        
      </form>
    </div>

    <!--  Info Box -->
    <div class="card" style="width: 40%">
      <div class="card-body" style="background-color: #e6e6e6;">
        <h5 class="card-title ms-4">Your Privacy, Our Trust</h5>
        <p class="card-text mt-3">Your files are encrypted on your device, split, and stored across your own Amazon S3, Google Drive, and OneDrive accounts. Even when you share, only the intended recipient can reassemble and decrypt themâ€”never us or anyone else.</p>
      </div>
    </div>


  </div>
  <script src="{{ url_for('static', filename='js/crypto.js') }}"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
   function validatePasswordStrength(password) {
      const passwordRegex = /^(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+={}\[\]:;<>,.?/~`\\|^\-]).{8,}$/;
      console.log(password);
      return passwordRegex.test(password);
    }


 document.addEventListener('DOMContentLoaded', function() {
  let keyShown = false;

  const form = document.getElementById('registerForm');

  form.addEventListener('submit', async function(event) {
    event.preventDefault();

    
    // Generate RSA keys
    const loginKeyPair = await generateLoginKeyPair();
    // loginKeyPair.publicKey
    // loginKeyPair.privateKey


    // generate the random key for password reset 
    // this is shown: 
    const randKey = await  generateRandomAESKey(); 
    const randKeyHex = rawKeyToHex(randKey);
    const resetKey = await hexToKey(randKeyHex);
    
    const pw1 = document.getElementById('password');
    const pw2 = document.getElementById('password2');
    if (validatePasswordStrength(pw1.value)){
        if (pw1.value  == pw2.value){
          const salt = generateSalt();


          // derive the key to encrypt private key: 
          const derivedKey = await deriveKeyFromPassword(pw1.value,salt);
          console.log("PBKDF key derived! ")

          //encrypt the private key and returns encrypted info and generated IV
          const encrypted = await encryptPrivateKey(loginKeyPair.privateKey,derivedKey)
          //encrypted.encryptedPrivateKey
          //encrypted.iv
          const resetPrivateKey_encrypted = await encryptPrivateKey(loginKeyPair.privateKey,resetKey)
          
         
          // also export the public key:
          const exportedLoginPubKey = await exportPublicKey(loginKeyPair.publicKey);
          

          // @@@@setup the enc keypair@@@@: 
          const encKeyPair = await generateEncryptionKeyPair();
          const resetEncPrivateKey_encrypted = await encryptPrivateKey(encKeyPair.privateKey,resetKey)
          console.log("enc keypair generated");
          const encSalt = generateSalt();

          //derive the key frm pwd: 
          const derivedKeyEnc = await deriveKeyFromPassword(pw1.value,encSalt);
          // enc the pvt key: 
          const encryptedEncKey = await encryptPrivateKey(encKeyPair.privateKey,derivedKeyEnc);
          //export the pub key
          const exportedEncPubKey = await exportPublicKey(encKeyPair.publicKey);
          
          // set the values into the fields: 
          document.getElementById('loginPrivateKey').value = bufferToBase64(encrypted.encryptedPrivateKey);
          document.getElementById('loginPublicKey').value = exportedLoginPubKey;
          document.getElementById('loginIV').value = bufferToBase64(encrypted.iv);
          document.getElementById('loginSalt').value = salt;

          document.getElementById('encPublicKey').value = exportedEncPubKey;
          document.getElementById('encPrivateKey').value = bufferToBase64(encryptedEncKey.encryptedPrivateKey);
          document.getElementById('encIV').value = bufferToBase64(encryptedEncKey.iv);
          document.getElementById('encSalt').value = encSalt;
          

          document.getElementById('resetPrivateKey_encrypted').value = bufferToBase64(resetPrivateKey_encrypted.encryptedPrivateKey);
          document.getElementById('resetIV').value = bufferToBase64(resetPrivateKey_encrypted.iv);

          document.getElementById('resetEncPrivateKey_encrypted').value = bufferToBase64(resetEncPrivateKey_encrypted.encryptedPrivateKey);
          document.getElementById('resetEncIV').value = bufferToBase64(resetEncPrivateKey_encrypted.iv);
          console.log('completed writing to hidden fields ');

        }
        else{
          window.location.href = window.location.pathname + "?error=mismatch_password";
          return;
        }
    }else{
      window.location.href = window.location.pathname + "?error=weak_password";
      return;
    }
    
    //
    const swalCustom= Swal.mixin({
        customClass: {
          confirmButton: "btn btn-success me-2",
          cancelButton: "btn btn-danger ms-2"
        },
        buttonsStyling: false
      });

      swalCustom.fire({
  title: '<i class="bi bi-key-fill"></i> Save Your Secret Key',
  html: `
    <h3 class="mb-4">This key is required for password resets. Save it securely. </h3>
    <h5>You will NOT be able to recover your account should you lose this key!</h5>
    <pre id="keyDisplay" style="user-select: all; font-family: monospace; font-size: 1em; padding: 10px; background-color: #f1f1f1; border-radius: 6px;">${randKeyHex}</pre>
    <button id="copyKeyBtn" class="custom-grey-btn-regular" style="margin-top: 10px;"><i class="bi bi-clipboard"></i> Copy Key</button>
    <div id="copyStatus" style="margin-top:10px;color:green;font-size:0.9em;"></div>
  `,
  showCancelButton: true,
  confirmButtonText: 'I have saved it, Register now!',
  cancelButtonText: 'Cancel',
   didOpen: () => {
    document.getElementById('copyKeyBtn').addEventListener('click', () => {
      const keyText = document.getElementById('keyDisplay').textContent;
      navigator.clipboard.writeText(keyText).then(() => {
        document.getElementById('copyStatus').innerHTML = "<a><i class='bi bi-clipboard-check'></i> Key copied to clipboard!</a>";
      }).catch(() => {
        document.getElementById('copyStatus').innerText = "Failed to copy. Please copy manually.";
      });
    });
  }
}).then((result) => {
  // password never submitted 
  pw1.value="";
  pw2.value="";
  
  if (result.isConfirmed) {
    event.target.submit(); // proceed with submission after confirmation
  } else {
    alert("Please save your key before continuing.");
  }
});
    //



  });
});
</script>

</div>
{% endblock %}

 