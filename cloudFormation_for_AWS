AWSTemplateFormatVersion: '2010-09-09'
Description: Create S3 bucket, IAM user with full access to that bucket, and access keys

Parameters:
  BucketName:
    Type: String
    Description: Enter the S3 bucket name to create (must be globally unique)

Resources:
  MyBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref BucketName

  MyAppUser:
    Type: AWS::IAM::User
    Properties:
      UserName: MyAppUser

  MyAppPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: MyAppS3FullAccess
      Users:
        - !Ref MyAppUser
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action: "s3:*"
            Resource:
              - !Sub arn:aws:s3:::${BucketName}
              - !Sub arn:aws:s3:::${BucketName}/*

  MyAppAccessKey:
    Type: AWS::IAM::AccessKey
    Properties:
      UserName: !Ref MyAppUser

Outputs:
  BucketName:
    Description: Name of the S3 bucket created
    Value: !Ref MyBucket

  AccessKeyId:
    Description: AWS Access Key ID for MyAppUser
    Value: !Ref MyAppAccessKey

  SecretAccessKey:
    Description: AWS Secret Access Key for MyAppUser
    Value: !GetAtt MyAppAccessKey.SecretAccessKey
